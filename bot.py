import os
import json
import requests
from flask import Flask, request

app = Flask(__name__)

# –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
BOT_TOKEN = os.environ.get('BOT_TOKEN')
WEB_APP_URL = "https://qwaszx112233.github.io/telegram-love-puzzle/"

def setup_bot_commands():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ –±–æ—Ç–∞"""
    url = f'https://api.telegram.org/bot{BOT_TOKEN}/setMyCommands'
    commands = [
        {"command": "start", "description": "üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞"},
        {"command": "game", "description": "üéÆ –ì—Ä–∞—Ç–∏ –≤ –≥—Ä—É"},
        {"command": "progress", "description": "üìä –ú—ñ–π –ø—Ä–æ–≥—Ä–µ—Å"},
        {"command": "phrases", "description": "üíñ –õ—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏"},
        {"command": "help", "description": "üìñ –î–æ–≤—ñ–¥–∫–∞"},
        {"command": "about", "description": "‚ÑπÔ∏è –ü—Ä–æ –≥—Ä—É"},
        {"command": "support", "description": "üÜò –î–æ–ø–æ–º–æ–≥–∞"}
    ]
    
    try:
        response = requests.post(url, json={"commands": commands})
        if response.status_code == 200:
            print("‚úÖ –ú–µ–Ω—é –∫–æ–º–∞–Ω–¥ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ!")
        else:
            print("‚ùå –ü–æ–º–∏–ª–∫–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–µ–Ω—é –∫–æ–º–∞–Ω–¥")
    except Exception as e:
        print(f"‚ùå –ü–æ–º–∏–ª–∫–∞: {e}")

def create_main_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π –∏–≥—Ä—ã"""
    return {
        'inline_keyboard': [[
            {
                'text': 'üéÆ –ì—Ä–∞—Ç–∏ –≤ Love Puzzle',
                'web_app': {'url': WEB_APP_URL}
            }
        ]]
    }

def create_reply_keyboard():
    """–°–æ–∑–¥–∞–µ—Ç reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏"""
    return {
        'keyboard': [
            ['üéÆ –ì—Ä–∞—Ç–∏', 'üìä –ú—ñ–π –ø—Ä–æ–≥—Ä–µ—Å'],
            ['üíñ –§—Ä–∞–∑–∏', 'üÜò –î–æ–ø–æ–º–æ–≥–∞'],
            ['üìñ –î–æ–≤—ñ–¥–∫–∞', '‚ÑπÔ∏è –ü—Ä–æ –≥—Ä—É']
        ],
        'resize_keyboard': True,
        'one_time_keyboard': False
    }

def send_message(chat_id, text, keyboard=None, reply_markup=None):
    """–£–ª—É—á—à–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
    url = f'https://api.telegram.org/bot{BOT_TOKEN}/sendMessage'
    data = {
        'chat_id': chat_id, 
        'text': text, 
        'parse_mode': 'HTML'
    }
    
    if keyboard:
        data['reply_markup'] = json.dumps(keyboard)
    elif reply_markup:
        data['reply_markup'] = json.dumps(reply_markup)
    
    try:
        response = requests.post(url, json=data)
        return response.status_code == 200
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è: {e}")
        return False

@app.route('/')
def home():
    return "üíñ Love Puzzle Bot is running!"

@app.route('/webhook', methods=['POST'])
def webhook():
    update = request.get_json()
    
    if 'message' in update:
        message = update['message']
        chat_id = message['chat']['id']
        text = message.get('text', '')
        user_name = message['chat'].get('first_name', '–∫–æ—Ö–∞–Ω–∞')
        
        print(f"–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤—ñ–¥ {user_name}: {text}")
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –∫–Ω–æ–ø–æ–∫
        if text == 'üéÆ –ì—Ä–∞—Ç–∏':
            keyboard = create_main_keyboard()
            send_message(chat_id, "üéÆ –ó–∞–ø—É—Å–∫–∞–π –≥—Ä—É —Ç–∞ –Ω–∞—Å–æ–ª–æ–¥–∂—É–π—Å—è –∫–æ—Ö–∞–Ω–Ω—è–º! üíï", keyboard)
            
        elif text == 'üìä –ú—ñ–π –ø—Ä–æ–≥—Ä–µ—Å':
            progress_text = f"""
üìä <b>–ü—Ä–æ–≥—Ä–µ—Å {user_name}</b>

üèÜ –ü—Ä–æ–π–¥–µ–Ω–æ —Ä—ñ–≤–Ω—ñ–≤: <b>15/30</b>
üíù –ó–Ω–∞–π–¥–µ–Ω–æ —Ñ—Ä–∞–∑: <b>23/40</b>
‚≠ê –†–µ–∫–æ—Ä–¥: <b>1250 –æ—á–æ–∫</b>
üéØ –ü–æ—Ç–æ—á–Ω–∏–π —Ä—ñ–≤–µ–Ω—å: <b>16</b>

–¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! –ü—Ä–æ–¥–æ–≤–∂—É–π —É —Ç–æ–º—É –∂ –¥—É—Å—ñ! üíï
            """
            keyboard = create_main_keyboard()
            send_message(chat_id, progress_text, keyboard)
            
        elif text == 'üíñ –§—Ä–∞–∑–∏':
            phrases_text = f"""
üíñ <b>–õ—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏</b>

–û—Å—å –¥–µ–∫—ñ–ª—å–∫–∞ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∏—Ö —Ñ—Ä–∞–∑ –∑ –≥—Ä–∏:

\"–¢–∏ - –º–æ—î –Ω–∞–π—â–∞—Å–ª–∏–≤—ñ—à–µ —á–∏—Å–ª–æ ‚ù§Ô∏è\"
\"–ù–∞—à–∞ –ª—é–±–æ–≤ —è–∫ 1+1=2 - —ñ–¥–µ–∞–ª—å–Ω–∞!\"
\"–ö–æ–∂–Ω–∞ –≥—Ä–∞ –∑ —Ç–æ–±–æ—é - —Ü–µ –Ω–æ–≤–∞ —ñ—Å—Ç–æ—Ä—ñ—è –∫–æ—Ö–∞–Ω–Ω—è üíñ\"

–ó–Ω–∞–π–¥–µ–Ω–æ: <b>23/40</b> —Ñ—Ä–∞–∑

–ü—Ä–æ–¥–æ–≤–∂—É–π –≥—Ä—É, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤—Å—ñ —Ñ—Ä–∞–∑–∏! üéÆ
            """
            keyboard = create_main_keyboard()
            send_message(chat_id, phrases_text, keyboard)
            
        elif text == 'üìñ –î–æ–≤—ñ–¥–∫–∞':
            help_text = """
<b>üìñ –î–æ–≤—ñ–¥–∫–∞ –ø–æ –≥—Ä—ñ Love Number Puzzle</b>

üéØ <b>–ú–µ—Ç–∞ –≥—Ä–∏:</b>
–û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞, —â–æ–± –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω—ñ —Ñ—Ä–∞–∑–∏ —Ç–∞ –ø—Ä–æ—Ö–æ–¥–∏—Ç–∏ —Ä—ñ–≤–Ω—ñ!

<b>üî¢ –ü—Ä–∞–≤–∏–ª–∞ –≥—Ä–∏:</b>
‚Ä¢ –û–±'—î–¥–Ω—É–π –æ–¥–Ω–∞–∫–æ–≤—ñ —á–∏—Å–ª–∞
‚Ä¢ –û–±'—î–¥–Ω—É–π —á–∏—Å–ª–∞, —â–æ –≤—ñ–¥—Ä—ñ–∑–Ω—è—é—Ç—å—Å—è –≤ 2 —Ä–∞–∑–∏  
‚Ä¢ –ö–æ–∂–Ω–µ –ø–æ—î–¥–Ω–∞–Ω–Ω—è –≤—ñ–¥–∫—Ä–∏–≤–∞—î –ª—é–±–æ–≤–Ω—É —Ñ—Ä–∞–∑—É
‚Ä¢ –ü—Ä–æ–π–¥–∏ –≤—Å—ñ 30 —Ä—ñ–≤–Ω—ñ–≤

<b>üéÆ –ö–µ—Ä—É–≤–∞–Ω–Ω—è:</b>
‚Ä¢ –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –º–∏—à—É –∞–±–æ —Ç–∞–ø –ø–æ –µ–∫—Ä–∞–Ω—É
‚Ä¢ –ü–µ—Ä–µ—Ç—è–≥—É–π —á–∏—Å–ª–∞ –¥–ª—è –æ–±'—î–¥–Ω–∞–Ω–Ω—è
‚Ä¢ –ê–≤—Ç–æ–∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É

–ì–æ—Ç–æ–≤–∏–π –¥–æ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–æ—ó –ø—Ä–∏–≥–æ–¥–∏? ü•∞
            """
            keyboard = create_main_keyboard()
            send_message(chat_id, help_text, keyboard)
            
        elif text == '‚ÑπÔ∏è –ü—Ä–æ –≥—Ä—É':
            about_text = """
<b>üíñ –ü—Ä–æ –≥—Ä—É Love Number Puzzle</b>

‚ú® <b>–°—Ç–≤–æ—Ä–µ–Ω–æ –∑ –ª—é–±–æ–≤'—é</b>

–¶—è –≥—Ä–∞ –±—É–ª–∞ —Å—Ç–≤–æ—Ä–µ–Ω–∞ —è–∫ –æ—Å–æ–±–ª–∏–≤–∏–π –ø–æ–¥–∞—Ä—É–Ω–æ–∫ –∫–æ—Ö–∞–Ω—ñ–π –ª—é–¥–∏–Ω—ñ. 

<b>üåü –û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:</b>
‚Ä¢ 30 —É–Ω—ñ–∫–∞–ª—å–Ω–∏—Ö —Ä—ñ–≤–Ω—ñ–≤ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—ñ
‚Ä¢ 40+ —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∏—Ö —Ñ—Ä–∞–∑ —Ç–∞ –ø–æ—Å–ª–∞–Ω—å
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ø—Ä–æ–≥—Ä–µ—Å—É
‚Ä¢ –ö—Ä–∞—Å–∏–≤—ñ –≤—ñ–∑—É–∞–ª—å–Ω—ñ –µ—Ñ–µ–∫—Ç–∏

<b>‚ù§Ô∏è –Ü–¥–µ—è –≥—Ä–∏:</b>
–ü–æ—î–¥–Ω—É–≤–∞—Ç–∏ —á–∏—Å–ª–∞ —Ç–∞ –≤—ñ–¥–∫—Ä–∏–≤–∞—Ç–∏ –ª—é–±–æ–≤ - —â–æ –º–æ–∂–µ –±—É—Ç–∏ –∫—Ä–∞—â–µ?

<code>–í–µ—Ä—Å—ñ—è: 2.1 | –°—Ç–≤–æ—Ä–µ–Ω–æ –∑ ‚ù§Ô∏è</code>
            """
            keyboard = create_main_keyboard()
            send_message(chat_id, about_text, keyboard)
            
        elif text == 'üÜò –î–æ–ø–æ–º–æ–≥–∞':
            support_text = """
<b>üÜò –î–æ–ø–æ–º–æ–≥–∞ —Ç–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∞</b>

<b>üîß –ü–æ—à–∏—Ä–µ–Ω—ñ –ø—Ä–æ–±–ª–µ–º–∏:</b>
‚Ä¢ –ì—Ä–∞ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î—Ç—å—Å—è - –ø–µ—Ä–µ–≤—ñ—Ä —ñ–Ω—Ç–µ—Ä–Ω–µ—Ç
‚Ä¢ –ü—Ä–æ–≥—Ä–µ—Å –Ω–µ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è - –¥–æ–∑–≤–æ–ª—å cookies
‚Ä¢ –ü–æ–º–∏–ª–∫–∏ - –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –≥—Ä—É

<b>üìß –ó–≤'—è–∑–æ–∫ –∑ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–æ–º:</b>
@bergmann1

–ì—Ä–∞ –Ω–∞–π–∫—Ä–∞—â–µ –ø—Ä–∞—Ü—é—î –≤ –æ—Å—Ç–∞–Ω–Ω—ñ—Ö –≤–µ—Ä—Å—ñ—è—Ö Telegram! üì±
            """
            send_message(chat_id, support_text)
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥
        elif text == '/start':
            setup_bot_commands()  # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–µ–Ω—é –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
            
            welcome_text = f"""
üíñ <b>Love Number Puzzle</b> üíñ

–ü—Ä–∏–≤—ñ—Ç {user_name}! –õ–∞—Å–∫–∞–≤–æ –ø—Ä–æ—Å–∏–º–æ –¥–æ –≥—Ä–∏ –ª—é–±–æ–≤—ñ —Ç–∞ —á–∏—Å–µ–ª! ‚ù§Ô∏è

üéÆ <b>–û—Å–æ–±–ª–∏–≤–æ—Å—Ç—ñ:</b>
‚Ä¢ 30 —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∏—Ö —Ä—ñ–≤–Ω—ñ–≤
‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è
‚Ä¢ –õ—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏
‚Ä¢ –ö—Ä–∞—Å–∏–≤—ñ –∞–Ω—ñ–º–∞—Ü—ñ—ó

<b>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂—á–µ –∞–±–æ –º–µ–Ω—é –∫–æ–º–∞–Ω–¥! üì±</b>
            """
            send_message(chat_id, welcome_text, reply_markup=create_reply_keyboard())
            
        elif text == '/game':
            keyboard = create_main_keyboard()
            send_message(chat_id, "üéÆ –ó–∞–ø—É—Å–∫–∞–π –≥—Ä—É —Ç–∞ –Ω–∞—Å–æ–ª–æ–¥–∂—É–π—Å—è –∫–æ—Ö–∞–Ω–Ω—è–º! üíï", keyboard)
            
        elif text == '/progress':
            progress_text = f"""
üìä <b>–ü—Ä–æ–≥—Ä–µ—Å {user_name}</b>

üèÜ –ü—Ä–æ–π–¥–µ–Ω–æ —Ä—ñ–≤–Ω—ñ–≤: <b>15/30</b>
üíù –ó–Ω–∞–π–¥–µ–Ω–æ —Ñ—Ä–∞–∑: <b>23/40</b>
‚≠ê –†–µ–∫–æ—Ä–¥: <b>1250 –æ—á–æ–∫</b>

–¢–∏ –º–æ–ª–æ–¥–µ—Ü—å! üíï
            """
            keyboard = create_main_keyboard()
            send_message(chat_id, progress_text, keyboard)
            
        elif text == '/phrases':
            phrases_text = """
üíñ <b>–õ—é–±–æ–≤–Ω—ñ —Ñ—Ä–∞–∑–∏</b>

–ó–Ω–∞–π–¥–µ–Ω–æ: <b>23/40</b> —Ä–æ–º–∞–Ω—Ç–∏—á–Ω–∏—Ö —Ñ—Ä–∞–∑

–ü—Ä–æ–¥–æ–≤–∂—É–π –≥—Ä—É, —â–æ–± –≤—ñ–¥–∫—Ä–∏—Ç–∏ –≤—Å—ñ —Ñ—Ä–∞–∑–∏! üéÆ
            """
            keyboard = create_main_keyboard()
            send_message(chat_id, phrases_text, keyboard)
            
        elif text == '/help':
            help_text = """
<b>üìñ –î–æ–≤—ñ–¥–∫–∞ –ø–æ –≥—Ä—ñ</b>

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π:
‚Ä¢ –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é üëá
‚Ä¢ –ö–æ–º–∞–Ω–¥–∏ —É —Å–ø–∏—Å–∫—É
‚Ä¢ –í–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –≥—Ä–∏

–û–±–µ—Ä–∏ –¥—ñ—é –∑ –º–µ–Ω—é! üéÆ
            """
            send_message(chat_id, help_text, reply_markup=create_reply_keyboard())
            
        elif text == '/about':
            about_text = """
<b>üíñ Love Number Puzzle</b>

–†–æ–º–∞–Ω—Ç–∏—á–Ω–∞ –≥—Ä–∞-–≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞ –∑ —á–∏—Å–ª–∞–º–∏!

–°—Ç–≤–æ—Ä–µ–Ω–æ –∑ –ª—é–±–æ–≤'—é ‚ù§Ô∏è
            """
            keyboard = create_main_keyboard()
            send_message(chat_id, about_text, keyboard)
            
        elif text == '/support':
            support_text = """
<b>üÜò –î–æ–ø–æ–º–æ–≥–∞</b>

–ó–≤'—è–∑–æ–∫ –∑ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–æ–º:
@bergmann1

–ü–∏—à–∏ —É —Ä–∞–∑—ñ –ø–∏—Ç–∞–Ω—å! üíï
            """
            send_message(chat_id, support_text)
            
        else:
            # –û—Ç–≤–µ—Ç –Ω–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
            unknown_text = f"""
–ü—Ä–∏–≤—ñ—Ç {user_name}! üëã

–ù–µ —Ä–æ–∑–ø—ñ–∑–Ω–∞–≤ –∫–æ–º–∞–Ω–¥—É. –û—Å—å —â–æ —è –≤–º—ñ—é:

<b>–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π:</b>
‚Ä¢ –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é –Ω–∏–∂—á–µ üëá
‚Ä¢ –ö–æ–º–∞–Ω–¥–∏ —É —Å–ø–∏—Å–∫—É
‚Ä¢ –í–µ–±-–¥–æ–¥–∞—Ç–æ–∫ –¥–ª—è –≥—Ä–∏

–û–±–µ—Ä–∏ –¥—ñ—é –∑ –º–µ–Ω—é! üéÆ
            """
            send_message(chat_id, unknown_text, reply_markup=create_reply_keyboard())
    
    return 'OK'

if __name__ == '__main__':
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –º–µ–Ω—é –∫–æ–º–∞–Ω–¥ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    print("üîÑ –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –º–µ–Ω—é –∫–æ–º–∞–Ω–¥...")
    setup_bot_commands()
    
    print("=" * 60)
    print("üíñ Love Number Puzzle Bot - –û–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è üíñ") 
    print("=" * 60)
    print("üöÄ –ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 5000...")
    print("‚úÖ –ú–µ–Ω—é –∫–æ–º–∞–Ω–¥ —Ç–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω—ñ!")
    print("=" * 60)
    
    app.run(host='0.0.0.0', port=5000, debug=False)
